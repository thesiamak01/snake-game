const canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),startGameScreen=document.querySelector(".start-game"),gameOverScreen=document.querySelector(".game-over"),finalScoreText=document.getElementById("finalScore"),gridSize=20;let tileCount,snake=[{x:10,y:10}],food={x:5,y:5},direction={x:1,y:0},score=0,highScore=localStorage.getItem("highScore")||0,gameSpeed=150,tongueOffset=0,obstacles=[],gameStarted=!1;function setCanvasSize(){let e=.8*Math.min(window.innerWidth,window.innerHeight);canvas.width=e,canvas.height=e,tileCount=canvas.width/20}function startGame(){startGameScreen.style.display="none",gameOverScreen.style.display="none",gameStarted=!0,resetGame(),gameLoop()}function gameLoop(){gameStarted&&(update(),draw(),setTimeout(gameLoop,gameSpeed))}function update(){let e={x:snake[0].x+direction.x,y:snake[0].y+direction.y};if(e.x<0||e.x>=tileCount||e.y<0||e.y>=tileCount||collision(e,snake)||collision(e,obstacles)){endGame();return}snake.unshift(e),e.x===food.x&&e.y===food.y?(++score>highScore&&(highScore=score,localStorage.setItem("highScore",highScore)),placeFood(),addObstacle()):snake.pop(),tongueOffset=(tongueOffset+1)%10}function draw(){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.strokeStyle="#fff",ctx.lineWidth=4,ctx.strokeRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#888",obstacles.forEach(e=>{ctx.fillRect(20*e.x,20*e.y,20,20)}),ctx.fillStyle="#4CAF50",snake.forEach((e,t)=>{0===t?drawHead(e):ctx.fillRect(20*e.x,20*e.y,20,20)}),ctx.fillStyle="#FF5252",ctx.beginPath(),ctx.arc(20*food.x+10,20*food.y+10,10,0,2*Math.PI),ctx.fill(),ctx.fillStyle="white",ctx.font="16px Arial",ctx.fillText(`امتیاز: ${score}`,10,20),ctx.fillText(`بیشترین امتیاز: ${highScore}`,10,40)}function drawHead(e){let t=20*e.x,o=20*e.y;ctx.fillStyle="#45a049",ctx.fillRect(t,o,20,20),ctx.beginPath(),1===direction.x?ctx.arc(t+20,o+10,10,Math.PI/2,1.5*Math.PI):-1===direction.x?ctx.arc(t,o+10,10,Math.PI/2,1.5*Math.PI,!0):1===direction.y?ctx.arc(t+10,o+20,10,Math.PI,0):-1===direction.y&&ctx.arc(t+10,o,10,Math.PI,0,!0),ctx.fillStyle="#45a049",ctx.fill(),ctx.strokeStyle="#FF5252",ctx.lineWidth=2,ctx.beginPath(),1===direction.x?(ctx.moveTo(t+20,o+10),ctx.lineTo(t+20+tongueOffset,o+10)):-1===direction.x?(ctx.moveTo(t,o+10),ctx.lineTo(t-tongueOffset,o+10)):1===direction.y?(ctx.moveTo(t+10,o+20),ctx.lineTo(t+10,o+20+tongueOffset)):-1===direction.y&&(ctx.moveTo(t+10,o),ctx.lineTo(t+10,o-tongueOffset)),ctx.stroke()}function placeFood(){food.x=Math.floor(Math.random()*tileCount),food.y=Math.floor(Math.random()*tileCount),snake.some(e=>e.x===food.x&&e.y===food.y)&&placeFood()}function addObstacle(){if(score%3==0&&score>0){let e={x:Math.floor(Math.random()*tileCount),y:Math.floor(Math.random()*tileCount)};collision(e,snake)||obstacles.push(e)}}function collision(e,t){return t.some(t=>t.x===e.x&&t.y===e.y)}function resetGame(){snake=[{x:10,y:10}],direction={x:1,y:0},score=0,obstacles=[],placeFood(),gameStarted=!0,gameOverScreen.style.display="none",gameLoop()}function endGame(){gameStarted=!1,finalScoreText.textContent=`امتیاز شما: ${score}`,gameOverScreen.style.display="block"}window.addEventListener("keydown",e=>{switch(e.key){case"ArrowUp":0===direction.y&&(direction={x:0,y:-1});break;case"ArrowDown":0===direction.y&&(direction={x:0,y:1});break;case"ArrowLeft":0===direction.x&&(direction={x:-1,y:0});break;case"ArrowRight":0===direction.x&&(direction={x:1,y:0})}}),window.addEventListener("resize",()=>{setCanvasSize()}),setCanvasSize(),startGameScreen.style.display="block";